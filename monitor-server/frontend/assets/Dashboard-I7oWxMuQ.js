import{_ as ue,r as B,w as z,o as Q,c as E,a as de,b as F,d as s,u as f,e as V,f as A,g as t,h as o,F as P,i as G,j as ie,k as m,l as _,m as ce,t as d,n as me,p as pe,q as _e,s as W,v as p,x as ge}from"./index-HcRE1oiW.js";import{u as ve}from"./metrics-DBv9CDMc.js";import{c as fe}from"./index-DXhuTxIz.js";const ye={class:"dashboard"},ke={class:"card-header"},Ce={class:"card-value"},be={class:"card-header"},xe={class:"card-value"},we={class:"card-header"},Fe={class:"card-value"},Ue={class:"card-header"},Me={class:"card-value"},De={class:"card-header"},Se={class:"usage-metrics"},Ne={class:"usage-item"},Ve={class:"usage-item"},Ae={class:"usage-item"},he={class:"control-panel"},Be={class:"control-item"},Ee={class:"control-item"},Pe={class:"control-item"},We={key:0,class:"group-header"},$e={class:"card-header"},Te={class:"host-info"},He={class:"metrics"},qe={class:"metric-item"},ze={class:"metric-item"},Ge={class:"metric-item"},Ie={class:"metric-item"},Le={class:"metric-item"},Oe={class:"metric-item"},je={__name:"Dashboard",setup(Re){const I=ge(),h=ie(),i=ve();let y=null;const S=B("label"),N=B(!1),k=B(""),x=B("");z(()=>h.query.ip,l=>{x.value=l||""},{immediate:!0}),z(x,l=>{I.replace({query:{...h.query,ip:l||void 0}})}),z(N,l=>{localStorage.setItem("detailMode",l)}),Q(()=>{const l=localStorage.getItem("detailMode");l!==null&&(N.value=l==="true")});const g=E(()=>{const l=i.hosts,e=l.length;if(e===0)return{totalHosts:0,totalCpuCores:0,totalMemory:0,totalDisk:0,avgCpuUsage:0,avgMemoryUsage:0,avgDiskUsage:0};const a=l.reduce((u,r)=>({cpuCores:u.cpuCores+r.cpu_cores,memory:u.memory+r.total_memory/1024/1024/1024,disk:u.disk+r.total_disk/1024/1024/1024,usedCpu:u.usedCpu+r.cpu_cores*r.cpu_usage/100,usedMemory:u.usedMemory+r.total_memory*r.memory_usage/100,usedDisk:u.usedDisk+r.total_disk*r.disk_usage/100}),{cpuCores:0,memory:0,disk:0,usedCpu:0,usedMemory:0,usedDisk:0});return{totalHosts:e,totalCpuCores:a.cpuCores,totalMemory:a.memory.toFixed(2),totalDisk:a.disk.toFixed(2),avgCpuUsage:a.usedCpu/a.cpuCores*100,avgMemoryUsage:a.usedMemory/(a.memory*1024*1024*1024)*100,avgDiskUsage:a.usedDisk/(a.disk*1024*1024*1024)*100}}),X=E(()=>{let l=i.hosts.map(e=>({...e,cpu_usage:Number(e.cpu_usage.toFixed(1)),memory_usage:Number(e.memory_usage.toFixed(1)),disk_usage:Number(e.disk_usage.toFixed(1)),network_io:Number(e.network_io.toFixed(2)),read_write_io:Number(e.read_write_io.toFixed(2))}));return x.value&&(l=l.filter(e=>e.ip.toLowerCase().includes(x.value.toLowerCase()))),l}),Y=E(()=>{const l=i.hosts.map(e=>e.label||"未分组");return[...new Set(l)].sort()}),Z=E(()=>{const l=X.value;if(S.value==="label"){const e=ee(l);return k.value?{[k.value]:e[k.value]||[]}:Object.keys(e).sort().reduce((a,u)=>(a[u]=e[u],a),{})}else{const e=k.value?l.filter(a=>(a.label||"未分组")===k.value):l;return{所有主机:te(e)}}});function ee(l){const e=l.reduce((a,u)=>{const r=u.label||"未分组";return a[r]||(a[r]=[]),a[r].push(u),a},{});return Object.keys(e).forEach(a=>{e[a].sort((u,r)=>u.ip.localeCompare(r.ip))}),e}function te(l){return[...l].sort((e,a)=>{switch(S.value){case"cpu":return a.cpu_usage-e.cpu_usage;case"memory":return a.memory_usage-e.memory_usage;case"disk":return a.disk_usage-e.disk_usage;case"ip":default:return e.ip.localeCompare(a.ip)}})}function v(l){const e=l.reduce((u,r)=>({cpuUsage:u.cpuUsage+r.cpu_usage,memoryUsage:u.memoryUsage+r.memory_usage,diskUsage:u.diskUsage+r.disk_usage,cpuCores:u.cpuCores+r.cpu_cores,totalMemory:u.totalMemory+r.total_memory,totalDisk:u.totalDisk+r.total_disk}),{cpuUsage:0,memoryUsage:0,diskUsage:0,cpuCores:0,totalMemory:0,totalDisk:0}),a=l.length;return{totalCores:e.cpuCores,totalMemSize:(e.totalMemory/1024/1024/1024).toFixed(2),totalDiskSize:(e.totalDisk/1024/1024/1024).toFixed(2),avgCpu:(e.cpuUsage/a).toFixed(2),avgMemory:(e.memoryUsage/a).toFixed(2),avgDisk:(e.diskUsage/a).toFixed(2)}}function $(l){switch(l){case"disk":return[{color:"#67C23A",percentage:50},{color:"#E6A23C",percentage:70},{color:"#F56C6C",percentage:85}];case"network":return[{color:"#67C23A",percentage:50},{color:"#E6A23C",percentage:70},{color:"#F56C6C",percentage:85}];case"diskio":return[{color:"#67C23A",percentage:50},{color:"#E6A23C",percentage:70},{color:"#F56C6C",percentage:85}];case"netconn":return[{color:"#67C23A",percentage:50},{color:"#E6A23C",percentage:70},{color:"#F56C6C",percentage:85}];default:return[{color:"#67C23A",percentage:50},{color:"#E6A23C",percentage:70},{color:"#F56C6C",percentage:90}]}}function T(l){return l>=90?"danger":l>=70?"warning":"success"}function oe(l){I.push(`/host-metrics/${l}`)}function L(){const l=fe.getDashboardWsURL();y=new WebSocket(l),y.onopen=()=>{console.log("WebSocket connected"),i.loading=!1},y.onmessage=e=>{try{const a=JSON.parse(e.data);i.hosts=a.hosts,i.loading=a.loading,i.error=a.error}catch(a){console.error("Failed to parse WebSocket message:",a),i.error="数据解析错误"}},y.onerror=e=>{console.error("WebSocket error:",e),i.error="WebSocket连接错误",i.loading=!1},y.onclose=()=>{console.log("WebSocket disconnected"),i.error="WebSocket连接已断开",i.loading=!1,setTimeout(()=>{L()},3e3)}}Q(()=>{i.loading=!0,L(),h.query.ip&&(x.value=h.query.ip)}),de(()=>{y&&(y.close(),y=null)});function O(l){return l>=1024?`${(l/1024).toFixed(2)} TB`:`${l} GB`}function H(l){return l>=85?"danger":l>=60?"warning":"success"}return(l,e)=>{const a=m("el-loading"),u=m("el-alert"),r=m("el-icon"),U=m("el-card"),M=m("el-col"),se=m("TrendCharts"),j=m("el-row"),w=m("el-option"),R=m("el-select"),le=m("el-input"),ae=m("el-switch"),q=m("el-space"),C=m("el-descriptions-item"),b=m("el-tag"),J=m("el-descriptions"),re=m("el-text"),D=m("el-progress");return _(),F("div",ye,[e[23]||(e[23]=s("h2",{class:"page-title"},"中台服务器监控",-1)),f(i).loading?(_(),V(a,{key:0,fullscreen:!0,text:"加载中..."})):A("",!0),f(i).error?(_(),V(u,{key:1,title:f(i).error,type:"error","show-icon":"",closable:"",onClose:e[0]||(e[0]=n=>f(i).error=null)},null,8,["title"])):A("",!0),f(i).error?A("",!0):(_(),V(j,{key:2,gutter:20,class:"overview-cards"},{default:o(()=>[t(M,{xs:24,sm:12,md:4},{default:o(()=>[t(U,{shadow:"hover"},{header:o(()=>[s("div",ke,[e[6]||(e[6]=s("span",null,"总主机数",-1)),t(r,null,{default:o(()=>[t(f(ce))]),_:1})])]),default:o(()=>[s("div",Ce,d(g.value.totalHosts),1)]),_:1})]),_:1}),t(M,{xs:24,sm:12,md:4},{default:o(()=>[t(U,{shadow:"hover"},{header:o(()=>[s("div",be,[e[7]||(e[7]=s("span",null,"CPU总核心数",-1)),t(r,null,{default:o(()=>[t(f(me))]),_:1})])]),default:o(()=>[s("div",xe,d(g.value.totalCpuCores),1)]),_:1})]),_:1}),t(M,{xs:24,sm:12,md:4},{default:o(()=>[t(U,{shadow:"hover"},{header:o(()=>[s("div",we,[e[8]||(e[8]=s("span",null,"内存总量",-1)),t(r,null,{default:o(()=>[t(f(pe))]),_:1})])]),default:o(()=>[s("div",Fe,d(O(g.value.totalMemory)),1)]),_:1})]),_:1}),t(M,{xs:24,sm:12,md:4},{default:o(()=>[t(U,{shadow:"hover"},{header:o(()=>[s("div",Ue,[e[9]||(e[9]=s("span",null,"磁盘总量",-1)),t(r,null,{default:o(()=>[t(f(_e))]),_:1})])]),default:o(()=>[s("div",Me,d(O(g.value.totalDisk)),1)]),_:1})]),_:1}),t(M,{xs:24,sm:24,md:8},{default:o(()=>[t(U,{shadow:"hover"},{header:o(()=>[s("div",De,[e[10]||(e[10]=s("span",null,"整体资源使用率",-1)),t(r,null,{default:o(()=>[t(se)]),_:1})])]),default:o(()=>[s("div",Se,[s("div",Ne,[e[11]||(e[11]=s("span",{class:"usage-label"},"CPU",-1)),s("span",{class:W(["usage-value",H(g.value.avgCpuUsage)])},d(g.value.avgCpuUsage.toFixed(1))+"% ",3)]),s("div",Ve,[e[12]||(e[12]=s("span",{class:"usage-label"},"内存",-1)),s("span",{class:W(["usage-value",H(g.value.avgMemoryUsage)])},d(g.value.avgMemoryUsage.toFixed(2))+"% ",3)]),s("div",Ae,[e[13]||(e[13]=s("span",{class:"usage-label"},"磁盘",-1)),s("span",{class:W(["usage-value",H(g.value.avgDiskUsage)])},d(g.value.avgDiskUsage.toFixed(1))+"% ",3)])])]),_:1})]),_:1})]),_:1})),s("div",he,[t(q,{wrap:"",size:30},{default:o(()=>[s("div",Be,[e[14]||(e[14]=s("span",null,"排序方式:",-1)),t(R,{modelValue:S.value,"onUpdate:modelValue":e[1]||(e[1]=n=>S.value=n),placeholder:"排序方式",style:{"min-width":"150px"}},{default:o(()=>[t(w,{label:"按标签分组",value:"label"}),t(w,{label:"按IP排序",value:"ip"}),t(w,{label:"按CPU占用排序",value:"cpu"}),t(w,{label:"按内存占用排序",value:"memory"}),t(w,{label:"按磁盘占用排序",value:"disk"})]),_:1},8,["modelValue"])]),s("div",Ee,[e[15]||(e[15]=s("span",null,"分组:",-1)),t(R,{modelValue:k.value,"onUpdate:modelValue":e[2]||(e[2]=n=>k.value=n),placeholder:"选择分组",clearable:"",onClear:e[3]||(e[3]=n=>k.value=""),style:{"min-width":"250px"}},{default:o(()=>[t(w,{label:"全部",value:""}),(_(!0),F(P,null,G(Y.value,n=>(_(),V(w,{key:n,label:n,value:n},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),s("div",Pe,[e[16]||(e[16]=s("span",null,"IP筛选:",-1)),t(le,{modelValue:x.value,"onUpdate:modelValue":e[4]||(e[4]=n=>x.value=n),placeholder:"输入IP进行筛选",clearable:"",style:{"min-width":"200px"}},null,8,["modelValue"])]),t(ae,{modelValue:N.value,"onUpdate:modelValue":e[5]||(e[5]=n=>N.value=n),"active-text":"详细","inactive-text":"简略"},null,8,["modelValue"])]),_:1})]),(_(!0),F(P,null,G(Z.value,(n,K,ne)=>(_(),F("div",{key:K,class:W(["host-group",`group-theme-${ne%4}`])},[S.value==="label"?(_(),F("div",We,[t(J,{column:2,border:""},{default:o(()=>[t(C,{label:"标签"},{default:o(()=>[p(d(K),1)]),_:2},1024),t(C,{label:"主机数量"},{default:o(()=>[p(d(n.length),1)]),_:2},1024),t(C,{label:"资源统计"},{default:o(()=>[t(q,{wrap:""},{default:o(()=>[t(b,null,{default:o(()=>[p("核心数: "+d(v(n).totalCores),1)]),_:2},1024),t(b,{type:"success"},{default:o(()=>[p("内存: "+d(v(n).totalMemSize)+" GB",1)]),_:2},1024),t(b,{type:"warning"},{default:o(()=>[p("磁盘: "+d(v(n).totalDiskSize)+" GB",1)]),_:2},1024)]),_:2},1024)]),_:2},1024),t(C,{label:"平均使用率"},{default:o(()=>[t(q,{wrap:""},{default:o(()=>[t(b,{type:T(v(n).avgCpu)},{default:o(()=>[p(" CPU: "+d(v(n).avgCpu)+"% ",1)]),_:2},1032,["type"]),t(b,{type:T(v(n).avgMemory)},{default:o(()=>[p(" 内存: "+d(v(n).avgMemory)+"% ",1)]),_:2},1032,["type"]),t(b,{type:T(v(n).avgDisk)},{default:o(()=>[p(" 磁盘: "+d(v(n).avgDisk)+"% ",1)]),_:2},1032,["type"])]),_:2},1024)]),_:2},1024)]),_:2},1024)])):A("",!0),t(j,{gutter:20},{default:o(()=>[(_(!0),F(P,null,G(n,c=>(_(),V(M,{key:c.ip,xs:24,sm:12,md:8,lg:6},{default:o(()=>[t(U,{class:"host-card",shadow:"hover",onClick:Je=>oe(c.ip)},{header:o(()=>[s("div",$e,[t(re,{class:"host-ip",truncated:""},{default:o(()=>[p(d(c.ip),1)]),_:2},1024),t(b,{size:"small"},{default:o(()=>[p(d(c.label||"未分组"),1)]),_:2},1024)])]),default:o(()=>[s("div",Te,[t(J,{column:2,border:"",size:"small"},{default:o(()=>[t(C,{label:"CPU核心"},{default:o(()=>[p(d(c.cpu_cores),1)]),_:2},1024),t(C,{label:"内存"},{default:o(()=>[p(d((c.total_memory/1024/1024/1024).toFixed(2))+" GB ",1)]),_:2},1024),t(C,{label:"磁盘"},{default:o(()=>[p(d((c.total_disk/1024/1024/1024).toFixed(2))+" GB ",1)]),_:2},1024),t(C,{label:"状态"},{default:o(()=>[t(b,{type:c.status==="online"?"success":"danger"},{default:o(()=>[p(d(c.status==="online"?"在线":"离线"),1)]),_:2},1032,["type"])]),_:2},1024)]),_:2},1024)]),s("div",He,[s("div",qe,[e[17]||(e[17]=s("span",{class:"metric-label"},"CPU使用率",-1)),t(D,{percentage:Number(c.cpu_usage.toFixed(1)),color:$("cpu")},null,8,["percentage","color"])]),s("div",ze,[e[18]||(e[18]=s("span",{class:"metric-label"},"内存使用率",-1)),t(D,{percentage:Number(c.memory_usage.toFixed(1)),color:$("memory")},null,8,["percentage","color"])]),s("div",Ge,[e[19]||(e[19]=s("span",{class:"metric-label"},"磁盘使用率",-1)),t(D,{percentage:Number(c.disk_usage.toFixed(1)),color:$("disk")},null,8,["percentage","color"])]),N.value?(_(),F(P,{key:0},[s("div",Ie,[e[20]||(e[20]=s("span",{class:"metric-label"},"网络IO",-1)),t(D,{percentage:Number((c.network_io*10).toFixed(1)),format:()=>`${c.network_io.toFixed(2)} MB`,color:[{color:"#409EFF",percentage:0},{color:"#67C23A",percentage:100}]},null,8,["percentage","format"])]),s("div",Le,[e[21]||(e[21]=s("span",{class:"metric-label"},"磁盘IO",-1)),t(D,{percentage:Number(c.read_write_io.toFixed(1)),format:()=>`${c.read_write_io.toFixed(2)} MB`,color:[{color:"#409EFF",percentage:50},{color:"#67C23A",percentage:100}]},null,8,["percentage","format"])]),s("div",Oe,[e[22]||(e[22]=s("span",{class:"metric-label"},"网络连接数",-1)),t(D,{percentage:Number((c.net_conn_count*.1).toFixed(1)),format:()=>c.net_conn_count.toString(),color:[{color:"#409EFF",percentage:50},{color:"#67C23A",percentage:100}]},null,8,["percentage","format"])])],64)):A("",!0)])]),_:2},1032,["onClick"])]),_:2},1024))),128))]),_:2},1024)],2))),128))])}}},Ye=ue(je,[["__scopeId","data-v-d016d678"]]);export{Ye as default};

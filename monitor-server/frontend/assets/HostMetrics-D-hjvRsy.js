import{_ as j,r as _,o as H,a as A,b as F,g as s,u as w,d as l,h as a,j as G,E as L,k as d,l as Z,v as q,G as x,x as J}from"./index-CHWozVXy.js";import{i as K}from"./index-CUeaqhHS.js";import{a as Q}from"./index-C5sSAzlx.js";const W={class:"host-metrics"},X={class:"time-range"},Y={class:"card-header"},ee={class:"card-header"},te={class:"card-header"},se={__name:"HostMetrics",setup(ae){const $=G(),z=J(),C=$.params.host,D=_(null),I=_(null),R=_(null),S=_(null),T=_(null);let m={cpu:null,memory:null,disk:null,network:null,diskIo:null};const v=_([]),V=[new Date(2e3,1,1,0,0,0),new Date(2e3,1,1,23,59,59)],B=[{text:"最近30分钟",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-30*60*1e3),[e,t]}},{text:"最近1小时",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-3600*1e3),[e,t]}},{text:"最近6小时",value:()=>{const t=new Date,e=new Date;return e.setTime(e.getTime()-6*3600*1e3),[e,t]}}];function P(){const t={cpu:D.value,memory:I.value,disk:R.value,network:S.value,diskIo:T.value};Object.entries(t).forEach(([e,o])=>{o&&(m[e]=K(o))})}function g(t,e,o,i="",k=!0){if(!t)return;const r=o.timestamps.map((n,u)=>({time:n,value:o.values[u]})).sort((n,u)=>n.time-u.time).filter(n=>n.value!==null),p=[];let c=[];r.forEach((n,u)=>{u>0&&n.time-r[u-1].time>12e4&&c.length>0&&(p.push(c),c=[]),c.push([n.time,n.value]),u===r.length-1&&c.length>0&&p.push(c)});const f=r.length>1?r[r.length-1].time-r[0].time:36e5,h=Math.max(Math.floor(f/10),1e3),y={title:{text:e,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross",animation:!1,snap:!1},formatter:function(n){if(n[0].value==="-")return"暂无数据";const u=Number(n[0].axisValue),b=r.reduce((N,O)=>Math.abs(O.time-u)<Math.abs(N.time-u)?O:N);return`
          <div style="padding: 3px;">
            <div style="margin-bottom: 3px;">${new Date(b.time).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})}</div>
            <div style="display: flex; justify-content: space-between;">
              <span style="margin-right: 15px;">${n[0].seriesName}:</span>
              <span style="font-weight: bold;">${b.value.toFixed(2)}${i}</span>
            </div>
          </div>
        `}},xAxis:{type:"time",minInterval:1e3,maxInterval:h,splitNumber:10,axisPointer:{snap:!1,label:{show:!0,formatter:n=>new Date(n.value).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}},axisLabel:{formatter:n=>new Date(n).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),rotate:45}},yAxis:{type:"value",axisLabel:{formatter:`{value}${i}`},min:0,max:i==="%"?100:void 0},series:p.map(n=>({name:e,type:"line",smooth:!0,symbol:"none",sampling:"lttb",data:n,connectNulls:!1,areaStyle:k?{opacity:.3}:void 0,lineStyle:{width:2},emphasis:{focus:"series",lineStyle:{width:3}}})),grid:{left:"3%",right:"4%",bottom:"15%",containLabel:!0},dataZoom:[{type:"inside",start:0,end:100},{type:"slider",start:0,end:100}]};t.setOption(y)}function U(t){const e={cpu:{timestamps:[],values:[]},memory:{timestamps:[],values:[]},disk:{timestamps:[],values:[]},network:{timestamps:[],values:[]},diskIo:{timestamps:[],values:[]}};return t.forEach(o=>{const i=new Date(o._time).getTime();switch(o._field){case"cpu_usage":e.cpu.timestamps.push(i),e.cpu.values.push(o._value);break;case"memory_usage":e.memory.timestamps.push(i),e.memory.values.push(o._value);break;case"disk_usage":e.disk.timestamps.push(i),e.disk.values.push(o._value);break;case"network_io":e.network.timestamps.push(i),e.network.values.push(o._value);break;case"read_write_io":e.diskIo.timestamps.push(i),e.diskIo.values.push(o._value);break}}),e}async function M(){var t;if(!((t=v.value)!=null&&t.length)){L.warning("请选择时间范围");return}try{const[e,o]=v.value,i=new URLSearchParams({host:C,start:e.toISOString(),end:o.toISOString()}),k=await Q.getHostMetrics(`${i}`),r=U(k);g(m.cpu,"CPU 使用率",r.cpu,"%"),g(m.memory,"内存使用率",r.memory,"%"),g(m.disk,"磁盘使用率",r.disk,"%"),g(m.network,"网络IO",r.network,"MB/s",!1),g(m.diskIo,"磁盘IO",r.diskIo,"MB/s",!1)}catch(e){console.error("获取指标数据失败:",e),L.error("获取指标数据时出现错误")}}function E(){Object.values(m).forEach(t=>{t==null||t.resize()})}return H(()=>{P(),window.addEventListener("resize",E);const t=new Date,e=new Date;e.setTime(e.getTime()-30*60*1e3),v.value=[e,t],M()}),A(()=>{window.removeEventListener("resize",E),Object.values(m).forEach(t=>{t==null||t.dispose()})}),(t,e)=>{const o=d("el-page-header"),i=d("el-date-picker"),k=d("el-button"),r=d("el-space"),p=d("el-icon"),c=d("el-tooltip"),f=d("el-card"),h=d("el-col"),y=d("el-row");return Z(),F("div",W,[s(o,{content:`主机监控: ${w(C)}`,onBack:e[0]||(e[0]=n=>w(z).back())},null,8,["content"]),l("div",X,[s(r,{wrap:""},{default:a(()=>[s(i,{modelValue:v.value,"onUpdate:modelValue":e[1]||(e[1]=n=>v.value=n),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",shortcuts:B,"default-time":V},null,8,["modelValue"]),s(k,{type:"primary",onClick:M},{default:a(()=>e[2]||(e[2]=[q(" 查询 ")])),_:1})]),_:1})]),s(y,{gutter:20},{default:a(()=>[s(h,{span:24},{default:a(()=>[s(f,{class:"chart-card"},{header:a(()=>[l("div",Y,[e[3]||(e[3]=l("span",null,"CPU 使用率历史数据",-1)),s(c,{content:"CPU使用率超过90%将触发告警",placement:"top"},{default:a(()=>[s(p,null,{default:a(()=>[s(w(x))]),_:1})]),_:1})])]),default:a(()=>[l("div",{ref_key:"cpuChartRef",ref:D,class:"chart"},null,512)]),_:1})]),_:1}),s(h,{span:24},{default:a(()=>[s(f,{class:"chart-card"},{header:a(()=>[l("div",ee,[e[4]||(e[4]=l("span",null,"内存使用率历史数据",-1)),s(c,{content:"内存使用率超过90%将触发告警",placement:"top"},{default:a(()=>[s(p,null,{default:a(()=>[s(w(x))]),_:1})]),_:1})])]),default:a(()=>[l("div",{ref_key:"memoryChartRef",ref:I,class:"chart"},null,512)]),_:1})]),_:1}),s(h,{span:24},{default:a(()=>[s(f,{class:"chart-card"},{header:a(()=>[l("div",te,[e[5]||(e[5]=l("span",null,"磁盘使用率历史数据",-1)),s(c,{content:"磁盘使用率超过85%将触发告警",placement:"top"},{default:a(()=>[s(p,null,{default:a(()=>[s(w(x))]),_:1})]),_:1})])]),default:a(()=>[l("div",{ref_key:"diskChartRef",ref:R,class:"chart"},null,512)]),_:1})]),_:1}),s(h,{span:12},{default:a(()=>[s(f,{class:"chart-card"},{header:a(()=>e[6]||(e[6]=[l("div",{class:"card-header"},[l("span",null,"网络IO历史数")],-1)])),default:a(()=>[l("div",{ref_key:"networkChartRef",ref:S,class:"chart"},null,512)]),_:1})]),_:1}),s(h,{span:12},{default:a(()=>[s(f,{class:"chart-card"},{header:a(()=>e[7]||(e[7]=[l("div",{class:"card-header"},[l("span",null,"磁盘IO历史数据")],-1)])),default:a(()=>[l("div",{ref_key:"diskIoChartRef",ref:T,class:"chart"},null,512)]),_:1})]),_:1})]),_:1})])}}},ue=j(se,[["__scopeId","data-v-550ee6b1"]]);export{ue as default};
